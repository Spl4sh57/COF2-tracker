<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suivi COF2 (Partagé)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel pour JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            overscroll-behavior-y: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            background-color: #1a1a1a;
            color: #e5e5e5;
            padding-bottom: env(safe-area-inset-bottom);
        }
        input, select, textarea {
            user-select: text;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect, useMemo, useRef } = React;

        // ==========================================
        // CONFIGURATION FIREBASE (HYBRIDE)
        // ==========================================
        
        let firebaseConfig;
        let appId = "table-de-jeu-cof2-principale"; 
        let isInternalEnv = false;

        // 1. Config Auto (Interne)
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                if (typeof __app_id !== 'undefined') appId = __app_id;
                isInternalEnv = true;
            }
        } catch (e) {
            console.log("Mode manuel détecté");
        }

        // 2. CONFIGURATION MANUELLE (GITHUB)
        if (!firebaseConfig) {
            firebaseConfig = {
                apiKey: "AIzaSyCI5jcHG5D0z0lRJk2Dya4wZQw5s-xINY0",
                authDomain: "tracker-cof2.firebaseapp.com",
                projectId: "tracker-cof2",
                storageBucket: "tracker-cof2.firebasestorage.app",
                messagingSenderId: "550291814114",
                appId: "1:550291814114:web:0a6d3e9e1646bbdf4210bb"
            };
            appId = "COF2-Splash"; 
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Icônes ---
        const IconBase = ({ size = 24, color = "currentColor", strokeWidth = 2, className = "", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const Icons = {
            Shield: (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></IconBase>,
            Zap: (p) => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></IconBase>,
            Sword: (p) => <IconBase {...p}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5" /><line x1="13" y1="19" x2="19" y2="13" /><line x1="16" y1="16" x2="20" y2="20" /><line x1="19" y1="21" x2="21" y2="19" /></IconBase>,
            Activity: (p) => <IconBase {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></IconBase>,
            Plus: (p) => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></IconBase>,
            Minus: (p) => <IconBase {...p}><line x1="5" y1="12" x2="19" y2="12" /></IconBase>,
            User: (p) => <IconBase {...p}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></IconBase>,
            Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconBase>,
            X: (p) => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></IconBase>,
            Edit2: (p) => <IconBase {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" /></IconBase>,
            Trash2: (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></IconBase>,
            ChevronRight: (p) => <IconBase {...p}><polyline points="9 18 15 12 9 6" /></IconBase>,
            ChevronLeft: (p) => <IconBase {...p}><polyline points="15 18 9 12 15 6" /></IconBase>,
            Star: (p) => <IconBase {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></IconBase>,
            Droplet: (p) => <IconBase {...p}><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" /></IconBase>,
            Dices: (p) => <IconBase {...p}><rect x="2" y="2" width="20" height="20" rx="5" ry="5" /><circle cx="12" cy="12" r="2" /><circle cx="6" cy="6" r="2" /><circle cx="18" cy="18" r="2" /></IconBase>,
            Cloud: (p) => <IconBase {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" /></IconBase>,
        };

        const PEUPLES = ["Demi-elfe", "Demi-orc", "Elfe haut", "Elfe Sylvain", "Gnome", "Halfelin", "Humain", "Nain", "Mage"];
        const PROFILS = ["Arquebusier", "Barde", "Rôdeur", "Voleur", "Barbare", "Chevalier", "Guerrier", "Ensorceleur", "Forgesort", "Magicien", "Sorcier", "Druide", "Moine", "Prêtre"];

        // --- Composant : Formulaire ---
        const CharacterForm = ({ character, onSave, onCancel, isSaving }) => {
            const [formData, setFormData] = useState(character || {
                id: null,
                name: '',
                race: PEUPLES[6],
                class: PROFILS[6],
                sex: 'M',
                color: '#3b82f6', 
                level: 1,
                hpCurrent: 20,
                hpMax: 20,
                initMod: 0,
                def: 10,
                luckPoints: 0,
                recoveryDice: 0,
                manaPoints: 0,
                notes: '' 
            });

            const handleChange = (e) => {
                const { name, value, type } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: type === 'number' ? Number(value) : value
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const submission = { 
                    ...formData, 
                    id: formData.id || crypto.randomUUID(), 
                    hpCurrent: (!character) ? formData.hpMax : formData.hpCurrent 
                };
                onSave(submission);
            };

            return (
                <div className="fixed inset-0 bg-black/95 z-50 overflow-y-auto p-4 animate-fade-in pb-32">
                    <div className="max-w-lg mx-auto bg-gray-800 rounded-xl p-4 shadow-2xl border border-gray-700">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">
                                {character ? "Modifier" : "Nouveau"}
                            </h2>
                            <button onClick={onCancel} className="p-2 hover:bg-gray-700 rounded-full text-gray-400 hover:text-white transition-colors">
                                <Icons.X size={24} />
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-1 gap-4">
                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Nom</label>
                                    <input required type="text" name="name" value={formData.name} onChange={handleChange} className="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none" placeholder="Ex: Karoom" />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">Peuple</label>
                                        <select name="race" value={formData.race} onChange={handleChange} className="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500">
                                            {PEUPLES.map(r => <option key={r} value={r}>{r}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">Profil</label>
                                        <select name="class" value={formData.class} onChange={handleChange} className="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500">
                                            {PROFILS.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div className="p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <div className="grid grid-cols-3 gap-3 mb-4">
                                    <div><label className="block text-xs text-center mb-1 text-red-400">PV Max</label><input type="number" name="hpMax" value={formData.hpMax} onChange={handleChange} className="w-full bg-gray-800 text-center p-2 rounded border border-gray-600 text-white font-bold focus:outline-none focus:border-red-500" /></div>
                                    <div><label className="block text-xs text-center mb-1 text-blue-400">Défense</label><input type="number" name="def" value={formData.def} onChange={handleChange} className="w-full bg-gray-800 text-center p-2 rounded border border-gray-600 text-white font-bold focus:outline-none focus:border-blue-500" /></div>
                                    <div><label className="block text-xs text-center mb-1 text-yellow-400">Init.</label><input type="number" name="initMod" value={formData.initMod} onChange={handleChange} className="w-full bg-gray-800 text-center p-2 rounded border border-gray-600 text-white font-bold focus:outline-none focus:border-yellow-500" /></div>
                                </div>
                                <div className="grid grid-cols-3 gap-3">
                                    <div><label className="block text-xs text-center mb-1 text-green-400">Chance</label><input type="number" name="luckPoints" value={formData.luckPoints || 0} onChange={handleChange} className="w-full bg-gray-800 text-center p-2 rounded border border-gray-600 text-white focus:outline-none focus:border-green-500" /></div>
                                    <div><label className="block text-xs text-center mb-1 text-purple-400">Récup.</label><input type="number" name="recoveryDice" value={formData.recoveryDice || 0} onChange={handleChange} className="w-full bg-gray-800 text-center p-2 rounded border border-gray-600 text-white focus:outline-none focus:border-purple-500" /></div>
                                    <div><label className="block text-xs text-center mb-1 text-blue-300">Mana</label><input type="number" name="manaPoints" value={formData.manaPoints || 0} onChange={handleChange} className="w-full bg-gray-800 text-center p-2 rounded border border-gray-600 text-white focus:outline-none focus:border-blue-300" /></div>
                                </div>
                            </div>

                             <div className="grid grid-cols-3 gap-3">
                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Sexe</label>
                                    <input type="text" name="sex" value={formData.sex || ''} onChange={handleChange} list="sex-options" className="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500 text-center" placeholder="M/F" />
                                    <datalist id="sex-options"><option value="F" /><option value="M" /><option value="NB" /></datalist>
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Niveau</label>
                                    <input type="number" name="level" value={formData.level} onChange={handleChange} className="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500 text-center" />
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Couleur</label>
                                    <div className="flex items-center h-[50px] bg-gray-900 rounded-lg border border-gray-700 px-1">
                                        <input type="color" name="color" value={formData.color} onChange={handleChange} className="w-full h-full bg-transparent cursor-pointer border-none p-0 rounded" />
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm text-gray-400 mb-1">Notes</label>
                                <textarea name="notes" value={formData.notes} onChange={handleChange} rows="3" className="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white text-sm focus:outline-none focus:border-blue-500"></textarea>
                            </div>

                            <div className="pt-4 flex gap-3">
                                <button type="button" onClick={onCancel} disabled={isSaving} className="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium text-white transition-colors">Annuler</button>
                                <button type="submit" disabled={isSaving} className="flex-1 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-white shadow-lg shadow-blue-900/20 flex justify-center items-center gap-2 transition-all active:scale-95">
                                    {isSaving ? <span className="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"/> : <><Icons.Save size={20} /> Sauvegarder</>}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Composant : Carte (Restructuré) ---
        const CharacterCard = ({ char, onUpdateHP, onSetHP, onViewDetail }) => {
            const barRef = useRef(null);
            const hpPercent = Math.max(0, Math.min(100, (char.hpCurrent / char.hpMax) * 100));
            
            let hpColor = "bg-green-500";
            if (hpPercent < 50) hpColor = "bg-yellow-500";
            if (hpPercent < 20) hpColor = "bg-red-600";
            if (char.hpCurrent <= 0) hpColor = "bg-gray-600";

            // Interaction Barre
            const handleBarInteraction = (clientX) => {
                if (!barRef.current) return;
                const rect = barRef.current.getBoundingClientRect();
                const x = clientX - rect.left;
                const width = rect.width;
                const ratio = Math.max(0, Math.min(1, x / width));
                const newHP = Math.round(ratio * char.hpMax);
                onSetHP(char, newHP);
            };

            const handleMouseDown = (e) => {
                e.stopPropagation(); 
                handleBarInteraction(e.clientX);
                const handleMouseMove = (moveEvent) => handleBarInteraction(moveEvent.clientX);
                const handleMouseUp = () => {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            };

            const handleTouchStart = (e) => {
                e.stopPropagation();
                handleBarInteraction(e.touches[0].clientX);
                const handleTouchMove = (moveEvent) => handleBarInteraction(moveEvent.touches[0].clientX);
                const handleTouchEnd = () => {
                    document.removeEventListener('touchmove', handleTouchMove);
                    document.removeEventListener('touchend', handleTouchEnd);
                };
                document.addEventListener('touchmove', handleTouchMove);
                document.addEventListener('touchend', handleTouchEnd);
            };

            return (
                <div className="bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-700 flex flex-col relative group active:border-gray-500 transition-colors">
                    
                    {/* Dégradé atmosphérique */}
                    <div 
                        className="absolute top-0 left-0 right-0 h-24 pointer-events-none opacity-40" 
                        style={{ background: `linear-gradient(to bottom, ${char.color}, transparent)` }}
                    ></div>

                    {/* Zone d'en-tête cliquable pour Détail */}
                    <div className="p-4 pb-1 flex-1 cursor-pointer relative z-10" onClick={() => onViewDetail(char)}>
                        <div className="flex justify-between items-start mb-2">
                            <div className="overflow-hidden">
                                <h3 className="text-xl font-bold text-white truncate pr-2" style={{ textShadow: '0 2px 4px rgba(0,0,0,0.8)' }}>{char.name}</h3>
                                <p className="text-gray-300 text-sm truncate drop-shadow-md">{char.race} {char.class} <span className="text-gray-400">•</span> Niv {char.level}</p>
                            </div>
                            <div className="flex flex-col items-end text-gray-300 min-w-[60px] drop-shadow-md">
                                <div className="flex items-center gap-1 text-sm"><Icons.Shield size={14} /> <span className="font-mono">{char.def}</span></div>
                                <div className="flex items-center gap-1 text-sm mt-1"><Icons.Zap size={14} /> <span className="font-mono">{char.initMod}</span></div>
                            </div>
                        </div>
                    </div>

                    {/* Zone Barre de Vie (Non cliquable pour le détail) */}
                    <div className="px-4 pb-4 relative z-10 mt-1">
                        <div 
                            ref={barRef}
                            onMouseDown={handleMouseDown}
                            onTouchStart={handleTouchStart}
                            className="w-full bg-gray-900 rounded-lg h-6 overflow-hidden border border-gray-600 relative cursor-col-resize touch-none hover:border-gray-400 transition-colors shadow-inner"
                        >
                            <div 
                                className={`h-full transition-all duration-100 ease-linear ${hpColor}`} 
                                style={{ width: `${hpPercent}%` }}
                            ></div>
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <span className="text-xs font-bold text-white drop-shadow-md select-none">
                                    {char.hpCurrent} / {char.hpMax}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 border-t border-gray-700 divide-x divide-gray-700 bg-gray-900/40 relative z-10">
                        <button onClick={(e) => { e.stopPropagation(); onUpdateHP(char, -1); }} className="py-4 flex items-center justify-center text-red-400 hover:bg-red-900/30 active:bg-red-900/50 transition-colors"><Icons.Minus size={28} strokeWidth={3} /></button>
                        <button onClick={(e) => { e.stopPropagation(); onUpdateHP(char, 1); }} className="py-4 flex items-center justify-center text-green-400 hover:bg-green-900/30 active:bg-green-900/50 transition-colors"><Icons.Plus size={28} strokeWidth={3} /></button>
                    </div>
                </div>
            );
        };

        // --- Composant : Détail ---
        const CharacterDetail = ({ char, onClose, onEdit, onDelete }) => {
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            if (!char) return null;

            return (
                <div className="fixed inset-0 bg-black z-40 overflow-y-auto animate-fade-in">
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                            <div className="bg-gray-800 border border-gray-600 p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
                                <div className="w-16 h-16 bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Trash2 className="text-red-500" size={32} /></div>
                                <h3 className="text-xl font-bold text-white mb-2">Supprimer {char.name} ?</h3>
                                <p className="text-gray-400 mb-6 text-sm">Cette action est irréversible.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowDeleteConfirm(false)} className="flex-1 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors">Annuler</button>
                                    <button onClick={() => onDelete(char.id)} className="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold transition-colors">Supprimer</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="sticky top-0 bg-gray-900/90 backdrop-blur-sm border-b border-gray-800 p-4 flex justify-between items-center z-50">
                        <button onClick={onClose} className="text-white flex items-center gap-1 pr-4 py-2"><Icons.ChevronLeft /> Retour</button>
                        <div className="flex gap-3">
                            <button onClick={() => onEdit(char)} className="p-2 bg-blue-600/20 text-blue-400 rounded-lg hover:bg-blue-600/40 transition-colors"><Icons.Edit2 size={20} /></button>
                            <button onClick={() => setShowDeleteConfirm(true)} className="p-2 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/40 transition-colors"><Icons.Trash2 size={20} /></button>
                        </div>
                    </div>
                    <div className="p-6 pb-24 max-w-2xl mx-auto">
                        <div className="text-center mb-8">
                            <div className="w-24 h-24 mx-auto rounded-full flex items-center justify-center text-3xl font-bold mb-4 shadow-2xl border-4 border-gray-800 relative" style={{ backgroundColor: char.color, color: 'rgba(0,0,0,0.4)' }}>
                                {char.name.substring(0, 2).toUpperCase()}
                            </div>
                            <h1 className="text-3xl font-bold text-white">{char.name}</h1>
                            <div className="flex flex-wrap justify-center gap-2 mt-2 text-gray-400 text-lg">
                                <span>{char.race}</span><span className="text-gray-600">•</span><span>{char.class}</span>
                                {char.sex && <><span className="text-gray-600">•</span><span>{char.sex}</span></>}
                                <span className="bg-gray-800 px-2 py-0.5 rounded text-sm ml-1 text-gray-300 border border-gray-700">Niv {char.level}</span>
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-4 mb-8">
                            <div className="bg-gray-800 p-4 rounded-xl border border-gray-700 text-center flex flex-col items-center shadow-lg"><Icons.Shield className="text-blue-400 mb-2" size={28} /><span className="text-2xl font-bold text-white">{char.def}</span><span className="text-xs text-gray-500 uppercase tracking-wide">Défense</span></div>
                            <div className="bg-gray-800 p-4 rounded-xl border border-gray-700 text-center flex flex-col items-center shadow-lg"><Icons.Zap className="text-yellow-400 mb-2" size={28} /><span className="text-2xl font-bold text-white">{char.initMod >= 0 ? `+${char.initMod}` : char.initMod}</span><span className="text-xs text-gray-500 uppercase tracking-wide">Initiative</span></div>
                            <div className="bg-gray-800 p-4 rounded-xl border border-gray-700 text-center flex flex-col items-center shadow-lg"><Icons.Activity className="text-red-400 mb-2" size={28} /><span className="text-2xl font-bold text-white">{char.hpCurrent}</span><span className="text-xs text-gray-500 uppercase tracking-wide">PV Actuels</span></div>
                        </div>
                        <div className="bg-gray-800 rounded-xl p-5 mb-6 border border-gray-700 shadow-md">
                            <h3 className="text-gray-400 uppercase text-sm font-bold mb-4 flex items-center gap-2"><Icons.Star size={16} /> Ressources</h3>
                            <div className="flex justify-between items-center border-b border-gray-700 pb-3 mb-3"><span className="flex items-center gap-2"><Icons.Star size={14} className="text-green-400"/> P. Chance</span><span className="text-xl font-bold text-white">{char.luckPoints || 0}</span></div>
                            <div className="flex justify-between items-center border-b border-gray-700 pb-3 mb-3"><span className="flex items-center gap-2"><Icons.Dices size={14} className="text-purple-400"/> Dés Récup.</span><span className="text-xl font-bold text-white">{char.recoveryDice || 0}</span></div>
                            <div className="flex justify-between items-center"><span className="flex items-center gap-2"><Icons.Droplet size={14} className="text-blue-400"/> P. Mana</span><span className="text-xl font-bold text-white">{char.manaPoints || 0}</span></div>
                        </div>
                        <div className="bg-gray-800 rounded-xl p-5 border border-gray-700 shadow-md">
                            <h3 className="text-gray-400 uppercase text-sm font-bold mb-4">Notes</h3>
                            {char.notes ? <div className="text-gray-300 whitespace-pre-wrap leading-relaxed">{char.notes}</div> : <p className="text-gray-600 italic">Aucune note.</p>}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Composant : Vue MJ ---
        const DMView = ({ characters, onClose }) => {
            return (
                <div className="fixed inset-0 bg-black z-40 overflow-y-auto animate-fade-in">
                    <div className="sticky top-0 bg-gray-900/90 backdrop-blur-sm border-b border-gray-800 p-4 flex items-center z-50">
                        <button onClick={onClose} className="text-white flex items-center gap-1 pr-4 py-2"><Icons.ChevronLeft /> Retour</button>
                        <h2 className="text-xl font-bold text-white ml-4">Vue MJ</h2>
                    </div>
                    <div className="p-4 pb-24 max-w-4xl mx-auto">
                        <div className="bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-700">
                            <table className="w-full text-left text-gray-300">
                                <thead className="text-xs text-gray-400 uppercase bg-gray-900/50">
                                    <tr>
                                        <th scope="col" className="px-6 py-3">Joueur</th>
                                        <th scope="col" className="px-6 py-3 text-center">DEF</th>
                                        <th scope="col" className="px-6 py-3 text-center">INIT</th>
                                        <th scope="col" className="px-6 py-3 text-center">PV</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-700">
                                    {characters.map(char => (
                                        <tr key={char.id} className="bg-gray-800 hover:bg-gray-700/50 transition-colors">
                                            <td className="px-6 py-4 font-medium text-white flex items-center gap-3">
                                                <span className="w-3 h-3 rounded-full inline-block shadow-sm" style={{ backgroundColor: char.color }}></span>
                                                <div className="flex flex-col">
                                                    <span className="truncate font-bold">{char.name}</span>
                                                    <span className="text-gray-500 text-xs">{char.class}</span>
                                                </div>
                                            </td>
                                            <td className="px-6 py-4 text-center font-mono text-lg font-bold text-blue-400">{char.def}</td>
                                            <td className="px-6 py-4 text-center font-mono text-lg font-bold text-yellow-400">{char.initMod >= 0 ? `+${char.initMod}` : char.initMod}</td>
                                            <td className="px-6 py-4 text-center">
                                                <span className={`font-bold ${char.hpCurrent <= 0 ? "text-red-500" : "text-white"}`}>{char.hpCurrent}</span>
                                                <span className="text-gray-500 text-xs"> / {char.hpMax}</span>
                                            </td>
                                        </tr>
                                    ))}
                                    {characters.length === 0 && (
                                        <tr><td colSpan="4" className="px-6 py-8 text-center text-gray-500 italic">Aucun personnage disponible.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Composant Principal ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [characters, setCharacters] = useState([]);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('list'); 
            const [selectedChar, setSelectedChar] = useState(null);
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                const initAuth = async () => {
                    if (isInternalEnv && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e) { await signInAnonymously(auth); }
                    } else { await signInAnonymously(auth); }
                };
                initAuth().catch(err => console.error("Auth Error", err));
                return onAuthStateChanged(auth, (u) => { setUser(u); if(!u) setLoading(false); });
            }, []);

            useEffect(() => {
                if (!user) return;
                let q;
                if (isInternalEnv) {
                    q = collection(db, 'artifacts', appId, 'public', 'data', 'characters');
                } else {
                    q = collection(db, 'tables', appId, 'characters'); 
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const chars = [];
                    snapshot.forEach((doc) => chars.push({ id: doc.id, ...doc.data() }));
                    chars.sort((a, b) => a.name.localeCompare(b.name));
                    setCharacters(chars);
                    setLoading(false);
                    if (selectedChar) { const up = chars.find(c => c.id === selectedChar.id); if(up) setSelectedChar(up); }
                }, (error) => { console.error(error); setLoading(false); });
                return () => unsubscribe();
            }, [user, selectedChar?.id]);

            const saveCharacter = async (charData) => {
                if (!user) return;
                setIsSaving(true);
                try {
                    let docRef = isInternalEnv ? doc(db, 'artifacts', appId, 'public', 'data', 'characters', charData.id) : doc(db, 'tables', appId, 'characters', charData.id);
                    await setDoc(docRef, charData);
                    setView('list');
                } catch (e) { alert("Erreur: " + e.message); } finally { setIsSaving(false); }
            };

            const deleteCharacter = async (id) => {
                if (!user) return;
                try {
                    let docRef = isInternalEnv ? doc(db, 'artifacts', appId, 'public', 'data', 'characters', id) : doc(db, 'tables', appId, 'characters', id);
                    await deleteDoc(docRef);
                    setView('list');
                    setSelectedChar(null);
                } catch (e) { console.error(e); }
            };

            const updateHP = async (char, amount) => {
                if (!user) return;
                const newHp = Math.max(0, Math.min(char.hpMax, char.hpCurrent + amount));
                if (newHp === char.hpCurrent) return; 
                let docRef = isInternalEnv ? doc(db, 'artifacts', appId, 'public', 'data', 'characters', char.id) : doc(db, 'tables', appId, 'characters', char.id);
                await setDoc(docRef, { hpCurrent: newHp }, { merge: true });
            };

            const setHP = async (char, value) => {
                if (!user) return;
                const newHp = Math.max(0, Math.min(char.hpMax, value));
                if (newHp === char.hpCurrent) return;
                let docRef = isInternalEnv ? doc(db, 'artifacts', appId, 'public', 'data', 'characters', char.id) : doc(db, 'tables', appId, 'characters', char.id);
                await setDoc(docRef, { hpCurrent: newHp }, { merge: true });
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="loading-spinner"></div></div>;

            return (
                <div className="min-h-screen pb-20">
                    <nav className="bg-gray-900 border-b border-gray-800 p-4 sticky top-0 z-30 shadow-md">
                        <div className="max-w-4xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-blue-600 p-1.5 rounded text-white shadow-lg shadow-blue-900/50"><Icons.Shield size={20} fill="currentColor" /></div>
                                <h1 className="text-xl font-bold bg-gradient-to-r from-white to-gray-400 bg-clip-text text-transparent">COF<span className="text-blue-500">Tracker</span></h1>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setView('mj')} className="text-xs text-gray-300 font-bold border border-gray-700 bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded transition-colors mr-2 h-[26px] flex items-center">MJ</button>
                                <span className="text-xs text-green-400 flex items-center gap-1 border border-green-900 bg-green-900/20 px-2 py-1 rounded h-[26px]"><Icons.Cloud size={12}/> En ligne</span>
                            </div>
                        </div>
                    </nav>

                    <main className="p-4 max-w-4xl mx-auto">
                        {characters.length === 0 ? (
                            <div className="text-center mt-20 text-gray-500 flex flex-col items-center animate-fade-in">
                                <div className="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mb-4 border border-gray-700"><Icons.User size={40} className="opacity-50" /></div>
                                <p className="text-lg font-medium">Aucun personnage.</p>
                                <p className="text-sm mt-2 text-gray-400">Ajoutez-en un et il sera visible par tous !</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 animate-fade-in">
                                {characters.map(char => (
                                    <CharacterCard key={char.id} char={char} onUpdateHP={updateHP} onSetHP={setHP} onViewDetail={(c) => { setSelectedChar(c); setView('detail'); }} />
                                ))}
                            </div>
                        )}
                    </main>

                    <button onClick={() => { setSelectedChar(null); setView('form'); }} className="fixed bottom-10 right-6 w-16 h-16 bg-blue-600 hover:bg-blue-500 text-white rounded-full shadow-xl shadow-blue-900/50 flex items-center justify-center transition-all hover:scale-105 active:scale-95 z-30" aria-label="Ajouter"><Icons.Plus size={32} strokeWidth={2.5} /></button>

                    {view === 'form' && <CharacterForm character={selectedChar} onSave={saveCharacter} onCancel={() => setView('list')} isSaving={isSaving} />}
                    {view === 'detail' && selectedChar && <CharacterDetail char={selectedChar} onClose={() => { setSelectedChar(null); setView('list'); }} onEdit={(c) => { setView('form'); }} onDelete={deleteCharacter} />}
                    {view === 'mj' && <DMView characters={characters} onClose={() => setView('list')} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
